function Q=rot_quat(R)
%{
t=cos((trace(R)-1)/2);
s=1/(2*sin(t));
w=s*[R(3,2)-R(2,3),;
     R(1,3)-R(3-1),;
     R(2,1)-R(1,2)]';
q=w*sin(t/2);
q0=cos(t/2);
%}
A=[1  1 -1 -1;
    1 -1  1 -1;
    1 -1 -1  1;
    1  1  1  1];
r=[R(1,1),R(2,2),R(3,3),1]';
qi=(A^-1)*r;
%{
q0=sqrt(qi(1));
q=[qi(2)^.5,qi(3)^.5,qi(4)^.5];
%}
qi=qi.^.5;
m=max(qi);
if m==qi(1)
    q0=qi(1);
    q1=(R(2,3)-R(3,2))/(4*q0);
    q2=(R(3,1)-R(1,3))/(4*q0);
    q3=(R(2,1)-R(1,2))/(4*q0);
    
elseif m==qi(2)
    q1=qi(2);
    q0=(R(2,3)-R(3,2))/(4*q1);
    q2=(R(1,2)+R(2,1))/(4*q1);
    q3=(R(3,1)+R(1,3))/(4*q1);
elseif m==qi(3)
    q2=qi(3);
    q0=(R(3,1)-R(1,3))/(4*q2);
    q1=(R(1,2)+R(2,1))/(4*q2);
    q3=(R(2,3)+R(3,2))/(4*q2);
elseif m==qi(4)
    q3=qi(4);
    q0=(R(2,1)-R(1,2))/(4*q3);
    q1=(R(3,1)+R(1,3))/(4*q3);
    q2=(R(2,3)+R(3,2))/(4*q3);
else
    error('max failed')
end
q=[q1 q2 q3];
Q=[q0,q]';
end